#include <stdio.h>
#include <stdlib.h>
#include "pico/stdlib.h"
#include "ra8876.h"

void demo_shapes(void) {
    uint16_t w = ra8876_get_width();
    uint16_t h = ra8876_get_height();

    ra8876_fill_screen(RA8876_BLACK);
    ra8876_printf(w/2 - 60, 10, RA8876_WHITE, "Shapes - Rot %d", ra8876_get_rotation() * 90);

    ra8876_print(10, 40, RA8876_GRAY, "Grid:");
    for (int x = 80; x < 280; x += 40)
        ra8876_draw_line(x, 60, x, 180, RA8876_DARKGRAY);
    for (int y = 60; y < 200; y += 40)
        ra8876_draw_line(80, y, 280, y, RA8876_DARKGRAY);

    ra8876_print(10, 200, RA8876_GRAY, "Rectangles:");
    ra8876_draw_rect(10, 220, 80, 50, RA8876_RED);
    ra8876_fill_rect(100, 220, 80, 50, RA8876_GREEN);
    ra8876_draw_rect(190, 220, 80, 50, RA8876_BLUE);
    ra8876_fill_rect(200, 230, 60, 30, RA8876_CYAN);

    ra8876_print(300, 40, RA8876_GRAY, "Rounded:");
    ra8876_draw_rounded_rect(300, 60, 100, 60, 12, RA8876_YELLOW);
    ra8876_fill_rounded_rect(310, 70, 80, 40, 8, RA8876_ORANGE);

    ra8876_print(300, 140, RA8876_GRAY, "Circles:");
    ra8876_draw_circle(350, 200, 35, RA8876_CYAN);
    ra8876_fill_circle(430, 200, 35, RA8876_MAGENTA);

    ra8876_print(10, 290, RA8876_GRAY, "Ellipses:");
    ra8876_draw_ellipse(100, 350, 60, 30, RA8876_WHITE);
    ra8876_fill_ellipse(220, 350, 30, 45, RA8876_RED);

    ra8876_print(300, 290, RA8876_GRAY, "Triangles:");
    ra8876_draw_triangle(350, 320, 310, 390, 390, 390, RA8876_WHITE);
    ra8876_fill_triangle(450, 320, 410, 390, 490, 390, RA8876_BLUE);

    ra8876_print(10, 410, RA8876_GRAY, "Lines:");
    for (int i = 0; i < 8; i++) {
        uint16_t color = ra8876_rgb565(255 - i*30, i*30, 128);
        ra8876_draw_line(80 + i*20, 430, 80 + i*20 + 80, h - 30, color);
    }

    static const uint8_t icon_32x32[128] = {
        0x00,0x00,0x00,0x00, 0x00,0x7F,0xFE,0x00, 0x01,0xFF,0xFF,0x80, 0x03,0xFF,0xFF,0xC0,
        0x07,0xFF,0xFF,0xE0, 0x0F,0xC0,0x03,0xF0, 0x1F,0x00,0x00,0xF8, 0x1E,0x00,0x00,0x78,
        0x3C,0x00,0x00,0x3C, 0x3C,0x00,0x00,0x3C, 0x78,0x00,0x00,0x1E, 0x78,0x00,0x00,0x1E,
        0x70,0x00,0x00,0x0E, 0xF0,0x00,0x00,0x0F, 0xF0,0x00,0x00,0x0F, 0xF0,0x00,0x00,0x0F,
        0xF0,0x00,0x00,0x0F, 0xF0,0x00,0x00,0x0F, 0xF0,0x00,0x00,0x0F, 0x70,0x00,0x00,0x0E,
        0x78,0x00,0x00,0x1E, 0x78,0x00,0x00,0x1E, 0x3C,0x00,0x00,0x3C, 0x3C,0x00,0x00,0x3C,
        0x1E,0x00,0x00,0x78, 0x1F,0x00,0x00,0xF8, 0x0F,0xC0,0x03,0xF0, 0x07,0xFF,0xFF,0xE0,
        0x03,0xFF,0xFF,0xC0, 0x01,0xFF,0xFF,0x80, 0x00,0x7F,0xFE,0x00, 0x00,0x00,0x00,0x00,
    };
    ra8876_print(350, 410, RA8876_GRAY, "BTE Expand:");
    ra8876_bte_expand(0, 350, 440, 32, 32, icon_32x32, RA8876_CYAN, RA8876_BLACK);
    ra8876_bte_expand(0, 390, 440, 32, 32, icon_32x32, RA8876_RED, RA8876_BLACK);
    ra8876_bte_expand(0, 430, 440, 32, 32, icon_32x32, RA8876_GREEN, RA8876_DARKGRAY);

    ra8876_printf(w - 150, h - 25, RA8876_WHITE, "%dx%d", w, h);

    sleep_ms(2000);
}

void demo_bounce(void) {
    ra8876_buffer_init(2);
    uint16_t sw = ra8876_get_width();
    uint16_t sh = ra8876_get_height();

    int x = 100, y = 100, dx = 5, dy = 3, bw = 100, bh = 70;
    uint8_t r = 255, g = 0, b = 0;
    int color_state = 0;
    uint32_t frame_count = 0, last_fps_time = time_us_32(), fps = 0;

    uint16_t bg_color = ra8876_rgb565(0, 0, 64);

    for (int i = 0; i < 120; i++) {
        uint32_t frame_start = time_us_32();
        ra8876_fill_screen(bg_color);

        x += dx; y += dy;
        if (x <= 0 || x + bw >= sw) { dx = -dx; x += dx; }
        if (y <= 30 || y + bh >= sh - 30) { dy = -dy; y += dy; }

        switch (color_state) {
            case 0: g += 8; if (g >= 255) { g = 255; color_state = 1; } break;
            case 1: r -= 8; if (r <= 0) { r = 0; color_state = 2; } break;
            case 2: b += 8; if (b >= 255) { b = 255; color_state = 3; } break;
            case 3: g -= 8; if (g <= 0) { g = 0; color_state = 4; } break;
            case 4: r += 8; if (r >= 255) { r = 255; color_state = 5; } break;
            case 5: b -= 8; if (b <= 0) { b = 0; color_state = 0; } break;
        }

        ra8876_fill_rect(x, y, bw, bh, ra8876_rgb565(r, g, b));
        ra8876_draw_rect(x, y, bw, bh, RA8876_WHITE);

        ra8876_printf(10, 10, RA8876_WHITE, "Double Buffer - Rot %d - FPS: %lu", ra8876_get_rotation() * 90, fps);
        ra8876_printf(10, sh - 22, RA8876_GRAY, "Tear-free animation via page flipping");

        ra8876_swap_buffers();

        frame_count++;
        uint32_t now = time_us_32();
        if (now - last_fps_time >= 1000000) { fps = frame_count; frame_count = 0; last_fps_time = now; }
        uint32_t frame_time = time_us_32() - frame_start;
        if (frame_time < 16000) sleep_us(16000 - frame_time);
    }
    ra8876_buffer_disable();
}

void demo_text(void) {
    uint16_t w = ra8876_get_width();
    uint16_t h = ra8876_get_height();

    ra8876_fill_screen(RA8876_BLUE);

    ra8876_fill_rect(0, 0, w, 30, RA8876_DARKGRAY);
    ra8876_printf(10, 8, RA8876_WHITE, "Text Editor Sim - Rot %d", ra8876_get_rotation() * 90);

    ra8876_fill_rect(0, 30, w, h - 60, RA8876_BLACK);

    ra8876_fill_rect(0, h - 30, w, 30, RA8876_DARKGRAY);

    ra8876_set_text_colors(RA8876_GREEN, RA8876_BLACK);

    const char *lines[] = {
        "#include <stdio.h>",
        "#include \"ra8876.h\"",
        "",
        "int main() {",
        "    ra8876_init();",
        "    ra8876_set_rotation(RA8876_ROTATE_90);",
        "    ra8876_print(0, 0, WHITE, \"Hello!\");",
        "    ",
        "    while (1) {",
        "        // Your code here",
        "    }",
        "    return 0;",
        "}",
    };

    int num_lines = sizeof(lines) / sizeof(lines[0]);
    for (int i = 0; i < num_lines; i++) {
        ra8876_set_text_cursor(8, 40 + i * 18);
        ra8876_put_string(lines[i]);
    }

    uint16_t cursor_x = 8 + 4 * 8;
    uint16_t cursor_y = 40 + 7 * 18;
    bool cursor_visible = true;
    uint32_t last_blink = time_us_32();

    for (int i = 0; i < 90; i++) {
        uint32_t now = time_us_32();
        if (now - last_blink >= 400000) {
            cursor_visible = !cursor_visible;
            last_blink = now;
            ra8876_fill_rect(cursor_x, cursor_y, 3, 17, cursor_visible ? RA8876_WHITE : RA8876_BLACK);
        }
        ra8876_printf(10, h - 22, RA8876_WHITE, "Line 8, Col 5 | %dx%d chars", w/8, (h-60)/18);
        sleep_ms(16);
    }
}

void demo_bte(void) {
    ra8876_buffer_init(2);
    uint16_t sw = ra8876_get_width();
    uint16_t sh = ra8876_get_height();

    ra8876_set_canvas_page(2);
    ra8876_fill_screen(RA8876_MAGENTA);
    ra8876_fill_rect(10, 10, 80, 80, RA8876_RED);
    ra8876_fill_rect(30, 30, 40, 40, RA8876_YELLOW);
    ra8876_fill_circle(50, 50, 20, RA8876_BLUE);

    ra8876_set_canvas_page(3);
    ra8876_fill_screen(RA8876_BLACK);
    for (int i = 0; i < 12; i++) {
        ra8876_fill_rect(i * 90, 0, 45, sh, ra8876_rgb565(i * 20, 50, 100));
    }

    int sprite_x = 100, sprite_y = 100, dx = 4, dy = 3;
    uint32_t frame_count = 0, last_fps_time = time_us_32(), fps = 0;

    for (int i = 0; i < 120; i++) {
        uint32_t frame_start = time_us_32();
        uint8_t draw_page = ra8876_get_draw_page();

        ra8876_bte_copy(3, 0, 0, draw_page, 0, 0, RA8876_WIDTH, RA8876_HEIGHT, RA8876_ROP_S);

        ra8876_bte_copy_chroma(2, 0, 0, draw_page, sprite_x, sprite_y, 100, 100, RA8876_MAGENTA);
        ra8876_bte_copy_chroma(2, 0, 0, draw_page, sprite_x + 120, sprite_y + 50, 100, 100, RA8876_MAGENTA);

        ra8876_set_canvas_page(draw_page);
        ra8876_printf(10, 10, RA8876_WHITE, "BTE Engine - Rot %d - FPS: %lu", ra8876_get_rotation() * 90, fps);
        ra8876_print(10, 30, RA8876_CYAN, "Sprites with chroma key (magenta=transparent)");

        ra8876_swap_buffers();

        sprite_x += dx; sprite_y += dy;
        if (sprite_x <= 0 || sprite_x + 220 >= sw) dx = -dx;
        if (sprite_y <= 50 || sprite_y + 150 >= sh) dy = -dy;

        frame_count++;
        uint32_t now = time_us_32();
        if (now - last_fps_time >= 1000000) { fps = frame_count; frame_count = 0; last_fps_time = now; }
        uint32_t frame_time = time_us_32() - frame_start;
        if (frame_time < 16000) sleep_us(16000 - frame_time);
    }

    ra8876_buffer_disable();
}

void demo_cursor(void) {
    uint16_t w = ra8876_get_width();
    uint16_t h = ra8876_get_height();

    ra8876_fill_screen(RA8876_BLACK);
    ra8876_fill_rect(0, 0, w, 30, RA8876_DARKGRAY);
    ra8876_printf(10, 8, RA8876_WHITE, "Hardware Cursor - Rot %d", ra8876_get_rotation() * 90);

    ra8876_fill_rect(20, 50, w - 40, h - 100, ra8876_rgb565(0, 0, 40));

    ra8876_set_text_colors(RA8876_GREEN, ra8876_rgb565(0, 0, 40));

    const char *text[] = {
        "The RA8876 has a hardware text cursor.",
        "It blinks automatically - ZERO CPU overhead!",
        "",
        "No SPI traffic needed for cursor animation.",
        "Perfect for text editors and terminals.",
    };

    for (int i = 0; i < 5; i++) {
        ra8876_set_text_cursor(30, 60 + i * 20);
        ra8876_put_string(text[i]);
    }

    ra8876_set_text_cursor(30, 60);
    ra8876_cursor_size(8, 16);
    ra8876_cursor_blink_rate(25);
    ra8876_cursor_show(true);

    ra8876_print(30, h - 80, RA8876_YELLOW, "Cursor blinks with no CPU!");

    sleep_ms(1500);

    ra8876_print(30, h - 55, RA8876_CYAN, "invert_area() for selection:");
    ra8876_invert_area(30, 60, 8 * 38, 20);
    sleep_ms(600);
    ra8876_invert_area(30, 80, 8 * 42, 20);
    sleep_ms(1000);

    ra8876_invert_area(30, 60, 8 * 38, 20);
    ra8876_invert_area(30, 80, 8 * 42, 20);
    ra8876_cursor_hide();
}

void demo_pip(void) {
    uint16_t w = ra8876_get_width();
    uint16_t h = ra8876_get_height();

    ra8876_set_canvas_page(0);
    ra8876_fill_screen(ra8876_rgb565(0, 0, 80));
    for (int i = 0; i < 25; i++) {
        ra8876_draw_line(0, i * 25, w, i * 25, RA8876_DARKGRAY);
        ra8876_draw_line(i * 50, 0, i * 50, h, RA8876_DARKGRAY);
    }
    ra8876_printf(w/2 - 120, h/2, RA8876_WHITE, "PIP Demo - Rot %d", ra8876_get_rotation() * 90);
    ra8876_print(w/2 - 180, h/2 + 30, RA8876_GRAY, "PIP windows float with ZERO background redraw!");

    ra8876_set_canvas_page(2);
    ra8876_fill_rect(0, 0, 180, 90, ra8876_rgb565(50, 0, 0));
    ra8876_draw_rect(0, 0, 180, 90, RA8876_RED);
    ra8876_print(10, 10, RA8876_WHITE, "HUD Window 1");
    ra8876_print(10, 30, RA8876_YELLOW, "HP: 100/100");
    ra8876_print(10, 50, RA8876_CYAN, "MP: 50/50");
    ra8876_print(10, 70, RA8876_GREEN, "Gold: 1234");

    ra8876_set_canvas_page(3);
    ra8876_fill_rect(0, 0, 140, 60, ra8876_rgb565(0, 50, 0));
    ra8876_draw_rect(0, 0, 140, 60, RA8876_GREEN);
    ra8876_print(10, 10, RA8876_WHITE, "Minimap");
    ra8876_fill_circle(70, 35, 5, RA8876_RED);
    ra8876_fill_rect(40, 25, 10, 10, RA8876_BLUE);

    ra8876_set_canvas_page(0);

    ra8876_pip1_enable(2, 20, 20, 180, 90);
    ra8876_pip2_enable(3, w - 160, 20, 140, 60);

    int pip1_x = 20, pip1_y = 20, pip1_dx = 3, pip1_dy = 2;
    int pip2_x = w - 160, pip2_y = 20, pip2_dx = -2, pip2_dy = 3;

    for (int i = 0; i < 100; i++) {
        pip1_x += pip1_dx; pip1_y += pip1_dy;
        if (pip1_x <= 0 || pip1_x + 180 >= w) pip1_dx = -pip1_dx;
        if (pip1_y <= 0 || pip1_y + 90 >= h - 50) pip1_dy = -pip1_dy;
        ra8876_pip1_move(pip1_x, pip1_y);

        pip2_x += pip2_dx; pip2_y += pip2_dy;
        if (pip2_x <= 0 || pip2_x + 140 >= w) pip2_dx = -pip2_dx;
        if (pip2_y <= 0 || pip2_y + 60 >= h - 50) pip2_dy = -pip2_dy;
        ra8876_pip2_move(pip2_x, pip2_y);

        sleep_ms(20);
    }

    ra8876_pip1_disable();
    ra8876_pip2_disable();
}

static const uint8_t oldschool_font[95 * 16] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x18,0x7C,0xC6,0xC0,0x78,0x3C,0x06,0xC6,0x7C,0x18,0x18,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0xC6,0xCC,0x18,0x30,0x60,0xCC,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,
    0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xCE,0xDE,0xF6,0xE6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xFE,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0xC6,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x62,0x66,0xFE,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xE6,0x66,0x6C,0x6C,0x78,0x6C,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x6C,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7E,0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xC6,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xFE,0xC6,0x8C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x80,0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,
    0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00,0x00,0x00,
    0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,0x00,0x00,
    0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x70,0x1C,0xC6,0x7C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x34,0x18,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x66,0xFE,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

void demo_cgram(void) {
    uint16_t w = ra8876_get_width();
    uint16_t h = ra8876_get_height();

    ra8876_cgram_init();
    ra8876_cgram_upload_font(oldschool_font, ' ', 95, 16);
    ra8876_select_cgram_font(RA8876_FONT_16);

    ra8876_fill_screen(ra8876_rgb565(0, 0, 32));
    ra8876_set_text_colors(RA8876_GREEN, ra8876_rgb565(0, 0, 32));

    ra8876_set_text_cursor(10, 10);
    ra8876_put_cgram_string("CUSTOM CGRAM FONT DEMO");

    ra8876_set_text_cursor(10, 40);
    ra8876_put_cgram_string("ABCDEFGHIJKLMNOPQRSTUVWXYZ");

    ra8876_set_text_cursor(10, 60);
    ra8876_put_cgram_string("abcdefghijklmnopqrstuvwxyz");

    ra8876_set_text_cursor(10, 80);
    ra8876_put_cgram_string("0123456789 !@#$%^&*()[]{}");

    ra8876_set_text_colors(RA8876_CYAN, ra8876_rgb565(0, 0, 32));
    ra8876_set_text_cursor(10, 120);
    ra8876_put_cgram_string("C:\\>DIR /W");

    ra8876_set_text_cursor(10, 140);
    ra8876_put_cgram_string(" Volume in drive C is RETRO_DOS");

    ra8876_set_text_cursor(10, 160);
    ra8876_put_cgram_string(" Directory of C:\\GAMES");

    ra8876_set_text_cursor(10, 180);
    ra8876_put_cgram_string("DOOM     QUAKE    DUKE3D   HEXEN");

    ra8876_select_internal_font(RA8876_FONT_16, RA8876_ENC_8859_1);
    ra8876_printf(10, h - 30, RA8876_WHITE, "CGRAM Font - Rot %d - %dx%d", ra8876_get_rotation() * 90, w, h);

    sleep_ms(2000);
}

void demo_transparency(void) {
    uint16_t w = ra8876_get_width();
    uint16_t h = ra8876_get_height();

    ra8876_fill_screen(RA8876_BLACK);

    for (int i = 0; i < 20; i++) {
        uint16_t color = ra8876_rgb565(i * 12, 50, 255 - i * 12);
        ra8876_fill_rect(i * (w / 20), 0, w / 20 + 1, h, color);
    }

    for (int y = 0; y < h; y += 40)
        ra8876_draw_line(0, y, w, y, RA8876_DARKGRAY);

    ra8876_printf(w/2 - 100, 10, RA8876_WHITE, "Text Transparency - Rot %d", ra8876_get_rotation() * 90);

    ra8876_set_text_transparent(false);
    ra8876_set_text_colors(RA8876_WHITE, RA8876_RED);
    ra8876_set_text_cursor(30, 70);
    ra8876_put_string("OPAQUE TEXT - Background fills character cells");

    ra8876_set_text_cursor(30, 100);
    ra8876_set_text_colors(RA8876_BLACK, RA8876_YELLOW);
    ra8876_put_string("Solid yellow background behind text");

    ra8876_set_text_transparent(true);
    ra8876_set_text_colors(RA8876_WHITE, RA8876_BLACK);
    ra8876_set_text_cursor(30, 160);
    ra8876_put_string("TRANSPARENT - Pattern shows through!");

    ra8876_set_text_cursor(30, 190);
    ra8876_set_text_colors(RA8876_YELLOW, RA8876_BLACK);
    ra8876_put_string("Perfect for HUDs, overlays, labels");

    ra8876_set_text_cursor(30, 220);
    ra8876_set_text_colors(RA8876_CYAN, RA8876_BLACK);
    ra8876_put_string("Background color is ignored");

    for (int i = 0; i < 8; i++) {
        uint16_t color = ra8876_rgb565(rand() % 256, rand() % 256, rand() % 256);
        ra8876_fill_circle(80 + i * 60, h - 100, 20 + rand() % 15, color);
    }

    ra8876_set_text_cursor(30, h - 130);
    ra8876_set_text_colors(RA8876_WHITE, RA8876_BLACK);
    ra8876_put_string("Transparent over circles - great for game UI!");

    ra8876_set_text_transparent(false);
    ra8876_select_internal_font(RA8876_FONT_16, RA8876_ENC_8859_1);

    sleep_ms(2000);
}

#define LIFE_CELL 6
#define LIFE_COLS (RA8876_WIDTH / LIFE_CELL)
#define LIFE_ROWS ((RA8876_HEIGHT - 30) / LIFE_CELL)

static uint8_t life_grid[LIFE_ROWS][LIFE_COLS];
static uint8_t life_next[LIFE_ROWS][LIFE_COLS];

static void life_init_glider_gun(void) {
    for (int y = 0; y < LIFE_ROWS; y++)
        for (int x = 0; x < LIFE_COLS; x++)
            life_grid[y][x] = 0;

    int ox = 10, oy = 10;
    int gun[][2] = {
        {0,4},{0,5},{1,4},{1,5},
        {10,4},{10,5},{10,6},{11,3},{11,7},{12,2},{12,8},{13,2},{13,8},
        {14,5},{15,3},{15,7},{16,4},{16,5},{16,6},{17,5},
        {20,2},{20,3},{20,4},{21,2},{21,3},{21,4},{22,1},{22,5},
        {24,0},{24,1},{24,5},{24,6},
        {34,2},{34,3},{35,2},{35,3}
    };
    int n = sizeof(gun) / sizeof(gun[0]);
    for (int i = 0; i < n; i++) {
        int x = ox + gun[i][0];
        int y = oy + gun[i][1];
        if (x < LIFE_COLS && y < LIFE_ROWS)
            life_grid[y][x] = 1;
    }
}

static void life_step(void) {
    for (int y = 0; y < LIFE_ROWS; y++) {
        for (int x = 0; x < LIFE_COLS; x++) {
            int xm = (x == 0) ? LIFE_COLS - 1 : x - 1;
            int xp = (x == LIFE_COLS - 1) ? 0 : x + 1;
            int ym = (y == 0) ? LIFE_ROWS - 1 : y - 1;
            int yp = (y == LIFE_ROWS - 1) ? 0 : y + 1;
            int n = life_grid[ym][xm] + life_grid[ym][x] + life_grid[ym][xp] +
                    life_grid[y][xm] + life_grid[y][xp] +
                    life_grid[yp][xm] + life_grid[yp][x] + life_grid[yp][xp];
            life_next[y][x] = life_grid[y][x] ? (n == 2 || n == 3) : (n == 3);
        }
    }
    for (int y = 0; y < LIFE_ROWS; y++)
        for (int x = 0; x < LIFE_COLS; x++)
            life_grid[y][x] = life_next[y][x];
}

void demo_life(void) {
    life_init_glider_gun();
    ra8876_buffer_init(2);

    uint32_t fps = 0, frames = 0, last_fps = time_us_32(), gen = 0;

    for (int f = 0; f < 150; f++) {
        uint8_t page = ra8876_get_draw_page();
        ra8876_bte_solid_fill(page, 0, 0, RA8876_WIDTH, RA8876_HEIGHT, RA8876_BLACK);

        ra8876_bte_batch_start(page, LIFE_CELL - 1, LIFE_CELL - 1);
        for (int y = 0; y < LIFE_ROWS; y++)
            for (int x = 0; x < LIFE_COLS; x++)
                if (life_grid[y][x])
                    ra8876_bte_batch_fill(x * LIFE_CELL, 30 + y * LIFE_CELL, RA8876_GREEN);
        ra8876_wait_task_busy();

        ra8876_set_canvas_page(page);
        ra8876_printf(10, 8, RA8876_WHITE, "Game of Life - Rot %d - Gen: %lu - FPS: %lu",
                      ra8876_get_rotation() * 90, gen, fps);

        ra8876_swap_buffers();
        life_step();
        gen++;

        frames++;
        uint32_t now = time_us_32();
        if (now - last_fps >= 1000000) { fps = frames; frames = 0; last_fps = now; }
    }

    ra8876_buffer_disable();
}

void run_demo_in_all_rotations(void (*demo)(void), const char *name) {
    for (uint8_t rot = 0; rot < 4; rot++) {
        ra8876_set_rotation(rot);
        printf("%s - Rotation %d\n", name, rot * 90);
        demo();
    }
    ra8876_set_rotation(RA8876_ROTATE_0);
}

int main() {
    stdio_init_all();
    sleep_ms(1000);

    printf("\n=== RA8876 Rotation Test Suite ===\n");

    if (!ra8876_init()) {
        printf("RA8876 init failed!\n");
        while (1) sleep_ms(1000);
    }

    printf("Chip ID: 0x%02X\n", ra8876_get_chip_id());

    while (1) {
        run_demo_in_all_rotations(demo_shapes, "Shapes");
        run_demo_in_all_rotations(demo_bounce, "Double Buffer");
        run_demo_in_all_rotations(demo_text, "Text");
        run_demo_in_all_rotations(demo_bte, "BTE Engine");
        run_demo_in_all_rotations(demo_cursor, "HW Cursor");
        run_demo_in_all_rotations(demo_pip, "PIP Windows");
        run_demo_in_all_rotations(demo_cgram, "CGRAM Font");
        run_demo_in_all_rotations(demo_transparency, "Transparency");
        run_demo_in_all_rotations(demo_life, "Game of Life");
    }
}
